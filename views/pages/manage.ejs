<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการระบบ - La Bye</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/components/scrollbar.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap">
</head>
<body>

    <nav class="navbar">
        <div class="container nav-content">
            <a href="/" class="nav-logo">La Bye</a>
            <div class="nav-menu">
                <a href="/" class="nav-link">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span>หน้าแรก</span>
                </a>
                <a href="/profile" class="nav-link">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    <span>โปรไฟล์</span>
                </a>
                <div class="nav-user">
                    <button class="nav-user-btn" onclick="this.parentElement.classList.toggle('open')">
                        <div class="nav-avatar nav-avatar-default"><%= (user.displayName || user.username).charAt(0) %></div>
                        <span class="nav-username"><%= user.displayName || user.username %></span>
                    </button>
                    <div class="nav-dropdown">
                        <a href="/manage">จัดการระบบ</a>
                        <div class="nav-dropdown-divider"></div>
                        <a href="/logout">ออกจากระบบ</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="manage-container">
            <h1 class="manage-title">จัดการระบบ</h1>

            <!-- Dashboard Stats -->
            <div class="card">
                <div class="dashboard-header">
                    <h2 class="card-title">แดชบอร์ด</h2>
                    <div class="dashboard-date-picker">
                        <input type="date" id="dashboardDate" value="<%= new Date().toISOString().slice(0, 10) %>">
                        <button type="button" class="btn btn-outline btn-sm" id="dashboardDateReset">รีเซ็ต</button>
                    </div>
                </div>
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="statVisits"><%= totalVisits %></div>
                        <div class="stat-label" id="statVisitsLabel">เข้าชมทั้งหมด</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statToday"><%= todayVisits %></div>
                        <div class="stat-label">เข้าชมวันนี้</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statUsers"><%= totalUsers %></div>
                        <div class="stat-label" id="statUsersLabel">ผู้ใช้</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statPosts"><%= posts.length %></div>
                        <div class="stat-label" id="statPostsLabel">โพสต์</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value"><%= totalComments %></div>
                        <div class="stat-label">ความคิดเห็น</div>
                    </div>
                </div>

                <div class="dashboard-chart">
                    <div class="chart-header">
                        <span class="chart-title">ผู้เข้าชม</span>
                        <div class="chart-controls">
                            <button type="button" class="chart-range-btn" data-days="3">3 วัน</button>
                            <button type="button" class="chart-range-btn active" data-days="7">7 วัน</button>
                            <button type="button" class="chart-range-btn" data-days="30">30 วัน</button>
                        </div>
                    </div>
                    <canvas id="visitChart" width="900" height="280"></canvas>
                </div>
            </div>

            <!-- All Posts -->
            <div class="card">
                <h2 class="card-title">โพสต์ทั้งหมด (<%= posts.length %>)</h2>
                <% if (posts.length === 0) { %>
                    <p class="empty-text">ยังไม่มีโพสต์</p>
                <% } else { %>
                    <div class="manage-list">
                        <% posts.forEach(function(post) { %>
                        <div class="manage-item">
                            <div class="manage-item-info">
                                <div class="manage-item-author">
                                    <strong><%= post.isAnonymous ? 'ไม่ระบุตัวตน' : (post.author ? (post.author.displayName || post.author.username) : 'ผู้ใช้ที่ถูกลบ') %></strong>
                                    <span class="manage-item-time"><%= new Date(post.created_at).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %></span>
                                </div>
                                <p class="manage-item-content"><%= post.content ? post.content.substring(0, 100) : '(รูปภาพ)' %><%= post.content && post.content.length > 100 ? '...' : '' %></p>
                                <div class="manage-item-stats">
                                    <span><%= post.likes || 0 %> ถูกใจ</span>
                                    <% if (post.image) { %><span>มีรูปภาพ</span><% } %>
                                </div>
                            </div>
                            <form action="/manage/post/delete/<%= post._id %>" method="POST" onsubmit="return confirm('ลบโพสต์นี้?')">
                                <button type="submit" class="btn btn-danger btn-sm">ลบ</button>
                            </form>
                        </div>
                        <% }) %>
                    </div>
                <% } %>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('click', function(e) {
            document.querySelectorAll('.nav-user').forEach(function(el) {
                if (!el.contains(e.target)) el.classList.remove('open');
            });
        });

        // Chart
        (function() {
            var canvas = document.getElementById('visitChart');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            var allVisits = <%- visits %>;
            var currentDays = 7;

            var tooltip = document.createElement('div');
            tooltip.className = 'chart-tooltip';
            canvas.parentElement.style.position = 'relative';
            canvas.parentElement.appendChild(tooltip);

            function drawChart(days, highlightIdx) {
                var dpr = window.devicePixelRatio || 1;
                var rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = 280 * dpr;
                canvas.style.width = rect.width + 'px';
                canvas.style.height = '280px';
                ctx.scale(dpr, dpr);

                var w = rect.width, h = 280;
                var padTop = 20, padBottom = 40, padLeft = 45, padRight = 20;
                var chartW = w - padLeft - padRight, chartH = h - padTop - padBottom;

                var labels = [], data = [];
                var now = new Date();
                for (var i = days - 1; i >= 0; i--) {
                    var d = new Date(now); d.setDate(d.getDate() - i);
                    var key = d.toISOString().slice(0, 10);
                    labels.push(key);
                    var found = allVisits.find(function(v) { return v.date === key; });
                    data.push(found ? found.count : 0);
                }

                var maxVal = Math.max.apply(null, data);
                if (maxVal === 0) maxVal = 10;
                maxVal = Math.ceil(maxVal * 1.2);

                ctx.clearRect(0, 0, w, h);

                ctx.strokeStyle = '#f0f0f0'; ctx.lineWidth = 1;
                for (var i = 0; i <= 5; i++) {
                    var y = padTop + (chartH / 5) * i;
                    ctx.beginPath(); ctx.moveTo(padLeft, y); ctx.lineTo(w - padRight, y); ctx.stroke();
                    ctx.fillStyle = '#aaa'; ctx.font = '11px Prompt, sans-serif'; ctx.textAlign = 'right';
                    ctx.fillText(Math.round(maxVal - (maxVal / 5) * i), padLeft - 8, y + 4);
                }

                if (data.length < 2) return;
                var stepX = chartW / (data.length - 1);
                var points = data.map(function(v, i) {
                    return { x: padLeft + i * stepX, y: padTop + chartH - (v / maxVal) * chartH };
                });

                var grad = ctx.createLinearGradient(0, padTop, 0, padTop + chartH);
                grad.addColorStop(0, 'rgba(66, 103, 178, 0.15)');
                grad.addColorStop(1, 'rgba(66, 103, 178, 0)');
                ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y);
                for (var i = 1; i < points.length; i++) {
                    var cx = (points[i-1].x + points[i].x) / 2;
                    ctx.bezierCurveTo(cx, points[i-1].y, cx, points[i].y, points[i].x, points[i].y);
                }
                ctx.lineTo(points[points.length-1].x, padTop + chartH);
                ctx.lineTo(points[0].x, padTop + chartH);
                ctx.closePath(); ctx.fillStyle = grad; ctx.fill();

                ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y);
                for (var i = 1; i < points.length; i++) {
                    var cx = (points[i-1].x + points[i].x) / 2;
                    ctx.bezierCurveTo(cx, points[i-1].y, cx, points[i].y, points[i].x, points[i].y);
                }
                ctx.strokeStyle = '#4267b2'; ctx.lineWidth = 2; ctx.stroke();

                points.forEach(function(p, i) {
                    var r = i === highlightIdx ? 5 : 3.5;
                    ctx.beginPath(); ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
                    ctx.fillStyle = i === highlightIdx ? '#4267b2' : '#fff'; ctx.fill();
                    ctx.strokeStyle = '#4267b2'; ctx.lineWidth = 2; ctx.stroke();
                });

                ctx.textAlign = 'center';
                labels.forEach(function(label, i) {
                    var parts = label.split('-');
                    ctx.fillStyle = '#aaa'; ctx.font = '11px Prompt, sans-serif';
                    ctx.fillText(parseInt(parts[2]) + '/' + parseInt(parts[1]), points[i].x, h - padBottom + 18);
                });

                window._chartState = { points: points, data: data, labels: labels };
            }

            drawChart(currentDays);

            canvas.addEventListener('mousemove', function(e) {
                var rect = canvas.getBoundingClientRect();
                var mx = e.clientX - rect.left;
                var state = window._chartState; if (!state) return;
                var closest = -1, minDist = Infinity;
                for (var i = 0; i < state.points.length; i++) {
                    var dist = Math.abs(mx - state.points[i].x);
                    if (dist < minDist) { minDist = dist; closest = i; }
                }
                drawChart(currentDays, closest);
                if (closest >= 0 && minDist < 50) {
                    var parts = state.labels[closest].split('-');
                    tooltip.innerHTML = '<strong>' + state.data[closest] + ' เข้าชม</strong><br>' + parseInt(parts[2]) + '/' + parseInt(parts[1]) + '/' + parts[0];
                    tooltip.style.opacity = '1';
                    tooltip.style.left = state.points[closest].x + 'px';
                    tooltip.style.top = (state.points[closest].y - 12) + 'px';
                } else { tooltip.style.opacity = '0'; }
            });

            canvas.addEventListener('mouseleave', function() { tooltip.style.opacity = '0'; drawChart(currentDays); });

            document.querySelectorAll('.chart-range-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chart-range-btn').forEach(function(b) { b.classList.remove('active'); });
                    btn.classList.add('active');
                    currentDays = parseInt(btn.dataset.days);
                    drawChart(currentDays);
                });
            });

            window.addEventListener('resize', function() { drawChart(currentDays); });
        })();

        // Daily stats
        var overallStats = { visits: <%= totalVisits %>, users: <%= totalUsers %>, posts: <%= posts.length %> };

        function loadDailyStats(date) {
            fetch('/manage/stats/' + date, { credentials: 'same-origin' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) return;
                document.getElementById('statVisits').textContent = data.visits;
                document.getElementById('statVisitsLabel').textContent = 'เข้าชม';
                document.getElementById('statUsers').textContent = data.users;
                document.getElementById('statPosts').textContent = data.posts;
            });
        }

        function resetToOverall() {
            document.getElementById('statVisits').textContent = overallStats.visits;
            document.getElementById('statVisitsLabel').textContent = 'เข้าชมทั้งหมด';
            document.getElementById('statUsers').textContent = overallStats.users;
            document.getElementById('statPosts').textContent = overallStats.posts;
            document.getElementById('dashboardDate').value = new Date().toISOString().slice(0, 10);
        }

        document.getElementById('dashboardDate').addEventListener('change', function() { if (this.value) loadDailyStats(this.value); });
        document.getElementById('dashboardDateReset').addEventListener('click', resetToOverall);
    </script>

</body>
</html>
